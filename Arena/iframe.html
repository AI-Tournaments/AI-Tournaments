<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>X Arena (IFrame)</title>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<meta content="yes" name="mobile-web-app-capable">
		<style>
			label {
				font-family: monospace;
			}
			label.Pending {
				color: blue;
			}
			label.Done {
				color: green;
			}
			label.DNF {
				color: red;
			}
			pre {
				margin-top: 0;
			}
		</style>
		<script src="https://chrisacrobat.github.io/js-compilation/CreateWorkerFromRemoteURL.js"></script>
		<script>
			'use strict'
			function isIframe(){
				try{
					return window.self !== window.top;
				}catch(e){
					return true;
				}
			}
			function onload(){
				if(isIframe()){
					let output = document.getElementById('output');
					let data = JSON.parse(decodeURI(location.hash.substring(1)));
					document.title = document.title.replace('X', data.arena);
					if(data.arena !== undefined){
						fetch('https://raw.githubusercontent.com/AI-Tournaments/GAME-Arena/master/properties.json'.replace('GAME', arena))
						.then(response => response.json())
						.then(json => {
							if(json.limits.teams.min === undefined ? true : json.limits.teams.min <= data.participants.length
							&& json.limits.teams.max === undefined ? true : data.participants.length <= json.limits.teams.max
							&& json.limits.participants.min === undefined ? true : json.limits.participants.min <= data.participants.flat().length
							&& json.limits.participants.max === undefined ? true : data.participants.flat().length <= json.limits.participants.max
							&& json.limits.participantsPerTeam.min === undefined ? true : json.limits.participantsPerTeam.min <= data.participants.sort((x,y)=>y.length-x.length)[0].length
							&& json.limits.participantsPerTeam.max === undefined ? true : data.participants.sort((x,y)=>x.length-y.length)[0].length <= json.limits.participantsPerTeam.max){
								createWorkerFromRemoteURL('https://raw.githubusercontent.com/AI-Tournaments/GAME-Arena/master/arena.js'.replace('GAME', data.arena), true).then(worker => {
									worker.onmessage = messageEvent => {
										output.innerHTML += '<label for="message_'+messageEvent.data.message.id+'" class="'+messageEvent.data.type+'">'+messageEvent.data.type+'</label><pre id="message_' + messageEvent.data.message.id + '" class="' + messageEvent.data.type + '">' + JSON.stringify(messageEvent.data.message, 0, 4) + '</pre>';
									};
									let errorCount = 0;
									worker.onerror = errorEvent => {
										let errorID = 'error' + errorCount++;
										output.innerHTML += '<label for="message_'+errorID+'" class="Error">Error</label><pre id="message_' + errorID + '" class="Error">' + errorEvent.message + '</pre>';
									}
									worker.postMessage({arena: data});
								});
							}else{
								output.innerHTML += '<label for="message_limit_error" class="Error">Error</label><pre id="message_limit_error" class="Error">This arena requiers 2 participants.' + messageEvent.data.arena.participants.flat().length + '/' + messageEvent.data.arena.participants.length + ' was givven.</pre>';
							}
						});
					}else{
						output.innerHTML = 'No arena defined.';
					}
				}else{
					window.location.replace(window.location.href.replace('iframe.html', ''));
				}
			};
			function getOutput(){
				function copyToClipboard(str){
					const el = document.createElement('textarea');
					el.value = str;
					document.body.appendChild(el);
					el.select();
					document.execCommand('copy');
					document.body.removeChild(el);
				};
				let output = {};
				output.arena = document.title.split(' ')[0];
				output.data = [];
				let list = document.getElementById('output').getElementsByTagName('pre');
				for(const key in list){
					if(list.hasOwnProperty(key)){
						let element = list[key];
						output.data.push({type: element.className, value: JSON.parse(element.innerHTML)});
					}
				}
				copyToClipboard(JSON.stringify(output));
			}
		</script>
	</head>
	<body onload="onload()">
		<div>
			<input type="button" onclick="getOutput()" value="Copy output">
		</div>
		<div id="output"></div>
	</body>
</html>
