<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>X Arena (IFrame)</title>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<meta content="yes" name="mobile-web-app-capable">
		<script src="https://chrisacrobat.github.io/js-compilation/CreateWorkerFromRemoteURL.js"></script>
		<script>
			'use strict'
			function isIframe(){
				try{
					return window.self !== window.top;
				}catch(e){
					return true;
				}
			}
			window.onhashchange = hashChangeEvent => {
				if(isIframe()){
					let data = JSON.parse(decodeURI(location.hash.substring(1)));
					document.title = document.title.replace('X', data.arena);
					if(data.arena !== undefined){
						for(let i=0; i < data.participants.length; i++){
							let info = {};
							info.src = data.participants[i];
							let nameParts = info.src.replace(/^.*\/\//, '').split('/');
							info.name = nameParts[1] + '/' + nameParts[2];
							for (const namePart of nameParts.slice(4)){
								info.name += '/' + namePart;
							}
							data.participants[i] = info;
						}
						createWorkerFromRemoteURL('https://raw.githubusercontent.com/AI-Tournaments/GAME-Arena/master/arena.js'.replace('GAME', data.arena), true).then(worker => {
							worker.onmessage = messageEvent => {
								document.getElementById('output').innerHTML += '<pre id="' + messageEvent.data.id + '">' + JSON.stringify(messageEvent.data, 0, 4) + '</pre>';
							};
							//for each match:
								worker.postMessage({arena: data, id: 0});
						});
					}else{
						document.body.innerHTML = 'No arena defined.';
					}
				}else{
					window.location.replace(window.location.href.replace('iframe.html', ''));
				}
			};
			function rerun(){
				document.getElementById('output').innerHTML = '';
				window.onhashchange();
			}
			function getOutput(){
				function copyToClipboard(str){
					const el = document.createElement('textarea');
					el.value = str;
					document.body.appendChild(el);
					el.select();
					document.execCommand('copy');
					document.body.removeChild(el);
				};
				let output = [];
				let list = document.getElementById('output').getElementsByTagName('pre');
				for(const key in list){
					if(list.hasOwnProperty(key)){
						output.push(list[key].innerHTML);
					}
				}
				copyToClipboard('[' + output.join(',') + ']');
			}
			window.onhashchange();
		</script>
	</head>
	<body>
		<div>
			<!--<input type="button" onclick="rerun()" value="Rerun">-->
			<input type="button" onclick="getOutput()" value="Copy output">
		</div>
		<div id="output"></div>
	</body>
</html>
