<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Participant worker (IFrame)</title>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<meta content="yes" name="mobile-web-app-capable">
		<script src="https://ai-tournaments.github.io/AI-Tournaments/Arena/ArenaHelper.js"></script>
		<script>
			'use strict'
			let _parent = null;
			let _worker = null;
			function a(){
				function isIframe(){
					try{
						return window.self !== window.top;
					}catch(e){
						return true;
					}
				}
				if(isIframe()){
					/*
					Promise.all(promises).then(() => {
						executionWatcher(data.settings.general.timelimit_ms);
					}).catch(error => _onError(error));
					function executionWatcher(executionLimit=1000){
						wrappers.forEach(participantWrapper => {
							participantWrapper.private.workers.forEach(workerWrapper => {
								let executionTimeViolation = workerWrapper.lastCalled === undefined ? false : executionLimit < new Date().getTime() - workerWrapper.lastCalled;
								if(workerWrapper.lastCalled === null || executionTimeViolation){
									participantWrapper.team.splice(participantWrapper.team.indexOf(participantWrapper), 1);
									if(executionTimeViolation){
										workerWrapper.worker.terminate();
										participantDropped(participantWrapper.participant, 'Execution time violation.', workerWrapper.name);
									}
								}
							});
						});
						if(!terminated){
							setTimeout(executionWatcher, executionLimit, executionLimit);
						}
					}
					*/
					function post(data){
						console.log("// TODO: Add executionWatcher.");
						_worker.postMessage(data)
					}
					function blockNetwork(){
						window.stop();
						window.requestAnimationFrame(blockNetwork);
					}
					window.onmessage = messageEvent => {
						if(_parent === null){
							_parent = messageEvent.source;
						}
						window.onmessage = messageEvent => {
							if(_parent === null){
								_parent = messageEvent.source;
							}
							switch(messageEvent.data.type){
								default: debugger; break;
								case 'post': post(messageEvent.data); break;
								case 'update': _worker.postMessage(messageEvent.data); break;
							}
						}
						ArenaHelper.CreateWorkerFromRemoteURL(messageEvent.data.url, true).then(worker=>{
							_worker = worker;
							if(!messageEvent.data.workerData.settings.general.allowRemoteExecution){
								blockNetwork();
							}
							let source = {participant: messageEvent.data.participant, name: messageEvent.data.name}
							_worker.onerror = messageEvent => {
								_parent.postMessage({type: 'Event', data: {event: 'Error', source: source, payload: {colno: messageEvent.colno, lineno: messageEvent.lineno, message: messageEvent.message}}}, '*');
							}
							_worker.onmessage = messageEvent => {
								_parent.postMessage({type: 'Event', data: {event: 'Message', source: source, payload: messageEvent.data}}, '*');
							}
							_worker.postMessage(messageEvent.data.workerData);
							_parent.postMessage({type: 'Event', data: {event: 'Worker-Created', source: source}}, '*');
						});
					}
				}else{
					window.location.replace(window.location.href.replace('\/(?:.(?!\/))+$', '/'));
				}
			}
		</script>
	</head>
	<body onload="a()"></body>
</html>
