<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Arena</title>
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-173346924-1"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-173346924-1');</script>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<meta content="yes" name="mobile-web-app-capable">
		<style>
			html, body, iframe {
				margin: 0;
				padding: 0;
				border: 0;
				width: 100%;
				height: 100%;
			}
		</style>
		<script src="https://chrisacrobat.github.io/js-compilation/CreateWorkerFromRemoteURL.js"></script>
		<script>
			'use strict'
			let arenaList = undefined;
			let participantList = undefined;
			let settings = undefined;
			let settings_json = undefined;
			let btnAddTeam = undefined;
			let btnTransfer = undefined;
			function getOption(element, event){
				for(const option of element.getElementsByTagName('option')){
					if(option.value === event.target.value){
						return option;
					}
				}
			}
			function sortOptions(selectElement){
				let options = [...selectElement.options];
				options.sort(function(a, b){
					if(a.value < b.value){return -1;}
					if(b.value < a.value){return 1;}
					return 0;
				});
				for(let option of options){
					selectElement.add(option);
				}
			}
			function transferToTeam(event){
				let selectElement_moveTo = document.getElementById(event.target.dataset.select);
				for(const selectElement of document.getElementsByClassName('participants')){
					for(let option of [...selectElement.selectedOptions]){
						selectElement_moveTo.add(option);
						option.selected = false;
					}
				}
				// TODO: Validate .participants.min/.max, .participantsPerTeam.min/.max
				sortOptions(selectElement_moveTo);
			}
			function onload(){
				arenaList = document.getElementById('arena-datalist');
				participantList = document.getElementById('participants-selectable');
				settings = document.getElementById('settings');
				btnAddTeam = document.getElementById('add-team');
				btnTransfer = document.getElementById('transfer');
				btnTransfer.onclick = transferToTeam;
				document.getElementById('arena').onchange = event => {
					let option = getOption(arenaList, event);
					if(option !== undefined){
						btnAddTeam.disabled = true;
						for(const element of document.getElementsByClassName('participant-team')){
							element.parentNode.removeChild(element);
						}
						document.title = event.target.value + ' Arena';
						getProperties(event.target.value);
						getParticipants(option.value, option.dataset.full_name);
					}
				}
				fetch('https://api.github.com/orgs/AI-Tournaments/repos').then(response => response.json()).then(repos => {
					repos.forEach(repo => {
						if(repo.full_name.endsWith('-Arena')){
							let option = document.createElement('option');
							option.value = repo.full_name.replace(/.*\/|-Arena/g, '');
							option.dataset.full_name = repo.full_name;
							arenaList.appendChild(option);
						}
					});
				});
			}
			function getParticipants(arena='', full_name){
				for(const selectElement of document.getElementsByClassName('participants')){
					while(0 < selectElement.length){
						selectElement.remove(0);
					}
				}
				let promises = [];
				fetch('https://api.github.com/repos/AI-Tournaments/'+arena+'-AI-Tournament-Participant/forks').then(response => response.json()).then(forks => {
					forks.forEach(fork => {
						promises.push(fetch('https://api.github.com/repos/' + fork.full_name + '/git/trees/master')
						.then(response => response.json())
						.then(data => {
							data.tree.forEach(file =>{
								if(file.path.endsWith('.js')){
									let option = document.createElement('option');
									option.dataset.name = fork.full_name + '/' + file.path;
									option.dataset.url = 'https://raw.githubusercontent.com/' + fork.full_name + '/' + fork.default_branch + '/' + file.path;
									option.innerHTML = option.dataset.name;
									participantList.appendChild(option);
								}
							});
						})
						.catch(error => {
							console.error(error);
						}));
					});
					Promise.all(promises).then(() => {
						sortOptions(participantList);
					})
				});
			}
			function getProperties(arena=''){
				fetch('https://raw.githubusercontent.com/AI-Tournaments/GAME-Arena/master/properties.json'.replace('GAME', arena))
				.then(response => response.json())
				.then(json => {
					settings_json = json;
					for(let index = 0; index < Math.max(1, json.limits.teams.min); index++){
						createTeam();
					}
					while(0 < settings.length){
						settings.remove(0);
					}
				});
			}
			function createTeam(){
				let teamIndex = document.getElementsByClassName('participant-team').length + 1;
				btnAddTeam.disabled = settings_json.limits.teams.max <= teamIndex;
				let teamID = 'participant-team-' + teamIndex;
				let participantTeam = document.createElement('div');
				participantTeam.classList.add('participant-team');
				let input = document.createElement('input');
				participantTeam.appendChild(input);
				let label = document.createElement('label');
				participantTeam.appendChild(label);
				let select = document.createElement('select');
				participantTeam.appendChild(select);
				input.type = 'button';
				input.dataset.select = teamID;
				input.value = btnTransfer.value;
				input.onclick = transferToTeam;
				label.for = teamID;
				label.innerHTML = 'Team ' + teamIndex;
				select.id = teamID;
				select.classList.add('participants');
				select.multiple = true;
				document.getElementById('participant-groups').appendChild(participantTeam);
			}
			function start(){ // TODO: 
				let json = {
					arena: 'Kalaha',
					participants: [], // TODO: Fill
					settings: {
						boardLength: 6,
						startValue: 4,
						averageOf: 4,
						rules: []
					}
				};
				let iframe = document.createElement('iframe');
				iframe.src = 'iframe.html#' + JSON.stringify(json);
				iframe.sandbox = 'allow-scripts';
				iframe.style.display = 'none';
				document.body.appendChild(iframe);
			}
		</script>
	</head>
	<body onload="onload()">
		<label for="arena">Arena:</label>
		<input list="arena-datalist" name="arena" id="arena"/>
		<datalist id="arena-datalist"></datalist>
		<input type="button" id="add-team" value="Add team" onclick="createTeam()" disabled>
		<div id="participant-groups">
			<div>
				<input type="button" id="transfer" data-select="participants-selectable" value="Transfer here">
				<label for="participants-selectable">Available participants</label>
				<select id="participants-selectable" class="participants" multiple></select>
			</div>
		</div>
		<form id="settings"></form>
	</body>
</html>
