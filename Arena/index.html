<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>X Arena</title>
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-173346924-1"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-173346924-1');</script>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">
		<meta content="yes" name="mobile-web-app-capable">
		<style>
			html, body, iframe {
				margin: 0;
				padding: 0;
				border: 0;
				width: 100%;
				height: 100%;
			}
		</style>
		<script src="https://chrisacrobat.github.io/js-compilation/CreateWorkerFromRemoteURL.js"></script>
		<script>
			'use strict'
			let arenaList = undefined;
			let participantList = undefined;
			let participantList_chosen = undefined;
			let settings = undefined;
			function getOption(element, event){
				for(const option of element.getElementsByTagName("option")){
					if(option.value === event.target.value){
						return option;
					}
				}
			}
			function sortOptions(select){
				let options = [...select.options];
				options.sort(function(a, b){
					if(a.value < b.value){return -1;}
					if(b.value < a.value){return 1;}
					return 0;
				});
				for(let option of options){
					select.add(option);
				}
			}
			function onload(){
				arenaList = document.getElementById('arena-datalist');
				participantList = document.getElementById('participants-selectable');
				participantList_chosen = document.getElementById('participants-chosen');
				settings = document.getElementById('settings');
				document.getElementById('arena').onchange = event => {
					let option = getOption(arenaList, event);
					if(option !== undefined){
						getSettings(event.target.value);
						getParticipants(option.value, option.dataset.full_name);
					}
				}
				document.getElementById('transfer').onclick = event => {
					let toSelect = [...participantList.selectedOptions];
					let toUnselect = [...participantList_chosen.selectedOptions];
					for(let option of toSelect){
						participantList_chosen.add(option);
						option.selected = false;
					}
					for(let option of toUnselect){
						participantList.add(option);
						option.selected = false;
					}
					sortOptions(participantList);
					sortOptions(participantList_chosen);
				}
				fetch('https://api.github.com/orgs/AI-Tournaments/repos').then(response => response.json()).then(repos => {
					repos.forEach(repo => {
						if(repo.full_name.endsWith('-Arena')){
							let option = document.createElement('option');
							option.value = repo.full_name.replace(/.*\/|-Arena/g, '');
							option.dataset.full_name = repo.full_name;
							arenaList.appendChild(option);
						}
					});
				});
			}
			function getParticipants(arena='', full_name){
				while(0 < participantList.length){
					participantList.remove(0);
				}
				while(0 < participantList_chosen.length){
					participantList_chosen.remove(0);
				}
				let promises = [];
				fetch('https://api.github.com/repos/AI-Tournaments/'+arena+'-AI-Tournament-Participant/forks').then(response => response.json()).then(forks => {
					forks.forEach(fork => {
						promises.push(fetch('https://api.github.com/repos/' + fork.full_name + '/git/trees/master')
						.then(response => response.json())
						.then(data => {
							data.tree.forEach(file =>{
								if(file.path.endsWith('.js')){
									let option = document.createElement('option');
									option.dataset.name = fork.full_name + '/' + file.path;
									option.dataset.url = 'https://raw.githubusercontent.com/' + fork.full_name + '/' + fork.default_branch + '/' + file.path;
									option.innerHTML = option.dataset.name;
									participantList.appendChild(option);
								}
							});
						})
						.catch(error => {
							console.error(error);
						}));
					});
					Promise.all(promises).then(() => {
						sortOptions(participantList);
					})
				});
			}
			function getSettings(arena=''){
				console.log(arena);
				fetch('https://raw.githubusercontent.com/AI-Tournaments/GAME-Arena/master/default-settings.json'.replace('GAME', arena))
				.then(response => response.json())
				.then(json => {
					while(0 < settings.length){
						settings.remove(0);
					}
					console.log(json);
				});
			}
			function start(){ // TODO: 
				let json = {
					arena: 'Kalaha',
					participants: [], // TODO: Fill
					settings: {
						boardLength: 6,
						startValue: 4,
						averageOf: 4,
						rules: []
					}
				};
				let iframe = document.createElement('iframe');
				iframe.src = 'iframe.html#' + JSON.stringify(settings);
				iframe.sandbox = 'allow-scripts';
				iframe.style.display = 'none';
				document.body.appendChild(iframe);
			}
		</script>
	</head>
	<body onload="onload()">
		<label for="arena">Arena:</label>
		<input list="arena-datalist" name="arena" id="arena"/>
		<datalist id="arena-datalist"></datalist>
		<label for="participants-selectable">Available participants:</label>
		<select id="participants-selectable" multiple></select>
		<input type="button" id="transfer" value="Transfer">
		<label for="participants-chosen">Chosen participants:</label>
		<select id="participants-chosen" multiple></select>
		<div id="settings"></div>
	</body>
</html>
